<html>
<head>
  <script type='text/javascript' src='openseadragon.min.js'></script>
  <script type='text/javascript' src='jquery.min.js'></script>


  <script type='text/javascript'>

  var Z = 0;

  var server_name = '';
  var data_path = '';
  var g_width = 0;
  var g_height = 0;
  var g_z = 0;

  var ready_for_next_slice = false;

  function parse_args() {

    // from http://stackoverflow.com/a/7826782/1183453
    var args = document.location.search.substring(1).split('&');
    argsParsed = {};
    for (var i=0; i < args.length; i++)
    {
        arg = unescape(args[i]);

        if (arg.length == 0) {
          continue;
        }

        if (arg.indexOf('=') == -1)
        {
            argsParsed[arg.replace(new RegExp('/$'),'').trim()] = true;
        }
        else
        {
            kvp = arg.split('=');
            argsParsed[kvp[0].trim()] = kvp[1].replace(new RegExp('/$'),'').trim();
        }
    }

    return argsParsed;

  };


  function create_viewer(page, visible, no_seg) {


      // create dom element
      var container_id = 'viewer_'+page;
      
      if (!visible) {
        var style = 'background-color:black;position:absolute;top:0px;left:0px;width:100%;height:100%;z-index:0'//display:none';
      } else {
        var style = 'background-color:black;position:absolute;top:0px;left:0px;width:100%;height:100%;z-index:1';
      }

      $('#viewers').append('<div id="'+container_id+'" class="viewers" style="'+style+'"></div>');

      var ts = images[page];
      // var ts2 = segmentations[page];


      var viewer = OpenSeadragon({
          id:            container_id,
          prefixUrl:     "images/",
          navigatorSizeRatio: 0.25,
          minZoomImageRatio: 0.5,
          maxZoomPixelRatio: 10,
          showNavigationControl: false,
          animationTime: 0,
          imageLoaderLimit: 3,
          tileSources:   ts
        });


      viewer.innerTracker.keyHandler = null;
      viewer.innerTracker.keyDownHandler = null;

        window.onkeydown = this.onkey;

          if (!visible) {
              viewer.addHandler('tile-drawn', function() {
                  ready_for_next_slice = true;
              });
          }



          return [viewer, null];


  };

  function propagate_viewport() {

    viewer.viewport.panTo(seg_viewer.viewport.getCenter(), true);
    // center = null;

    // zoom = parseFloat(zoom);
    viewer.viewport.zoomTo(seg_viewer.viewport.getZoom(), null, true);    

  };


  window.onload = function() {


    var args = parse_args();

    server_name = args['server'];
    data_path = args['data_path'];
    g_width = parseInt(args['width'],10);
    g_height = parseInt(args['height'],10);
    g_z = 0//parseInt(args['z'],10);

    // console.log(args)

    images = [];
    for(var i=0; i<917; i++) {

        var ts = {
            height: g_height,//#512*256,
            width:  g_width,//512*256,
            tileSize: 512,
            minLevel: 0,
            maxLevel: Math.log2(g_width/512),

            getTileUrl: function( level, x, y ){

                level = this.maxLevel - level;

                // return "http://s3.amazonaws.com/com.modestmaps.bluemarble/" +
                        // (level-8) + "-r" + y + "-c" + x + ".jpg";

                x = x*this.tileSize;
                y = y*this.tileSize;
                
                return "http://"+server_name+"/data/?datapath="+data_path+"&start="+x+","+y+","+g_z+"&mip="+level+"&size="+this.tileSize+","+this.tileSize+",1"
            }
        };

        images.push(ts);

    }


    var viewers = create_viewer(g_z, true, true);
    viewer = viewers[0];
    // seg_viewer = viewers[1];
    next_viewers = create_viewer(g_z+1, false, true);


  }


  function onkey() {

    if (!ready_for_next_slice) return;

    ready_for_next_slice = false;

    next_viewers[0].removeAllHandlers('tile-drawn');

    var container_id = 'viewer_'+g_z;

    var new_container_id = 'viewer_'+(g_z+1);

    next_viewers[0].viewport.panTo(viewer.viewport.getCenter());
    next_viewers[0].viewport.zoomTo(viewer.viewport.getZoom());

    $('#'+new_container_id).css('z-index','1');

    // delete old viewers
    $('#'+container_id).css('z-index','0');
    viewer.destroy();
    

    g_z += 1;

    viewer = next_viewers[0];
    // seg_viewer = next_viewers[1];
    next_viewers = create_viewer(g_z+1, false, true);

  }


  </script>
</head>

<body>
<div id='viewers' style='position:absolute;top:0px;left:0px;width:100%;height:100%'></div>
</body>
</html>