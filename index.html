<html>
<head>
  <script type='text/javascript' src='openseadragon.min.js'></script>
  <script type='text/javascript' src='jquery.min.js'></script>


  <script type='text/javascript'>

  var Z = 0;

  var server_name = '';
  var data_path = '';
  var g_width = 0;
  var g_height = 0;
  var g_z = 0;
  var g_depth = 0;

  var ready_for_next_slice = false;

  function parse_args() {

    // from http://stackoverflow.com/a/7826782/1183453
    var args = document.location.search.substring(1).split('&');
    argsParsed = {};
    for (var i=0; i < args.length; i++)
    {
        arg = unescape(args[i]);

        if (arg.length == 0) {
          continue;
        }

        if (arg.indexOf('=') == -1)
        {
            argsParsed[arg.replace(new RegExp('/$'),'').trim()] = true;
        }
        else
        {
            kvp = arg.split('=');
            argsParsed[kvp[0].trim()] = kvp[1].replace(new RegExp('/$'),'').trim();
        }
    }

    return argsParsed;

  };

  function create_ts(z) {
      var ts = {
                height: g_height,//#512*256,
                width:  g_width,//512*256,
                tileSize: 512,
                minLevel: 0,
                maxLevel: Math.ceil(Math.log2(g_width/512)),

                getTileUrl: function( level, x, y ){

                    level = this.maxLevel - level;

                    // return "http://s3.amazonaws.com/com.modestmaps.bluemarble/" +
                    // (level-8) + "-r" + y + "-c" + x + ".jpg";

                    x = x*this.tileSize;
                    y = y*this.tileSize;

                    return "http://"+server_name+"/data/?datapath="+data_path+"&start="+x+","+y+","+z+"&mip="+level+"&size="+this.tileSize+","+this.tileSize+",1"
                }
      }
      return ts;

  }

  function create_viewer(page, visible, no_seg) {

      //console.log("page is: " + page);
      if ((page < 0) || (page >= g_depth))
          return;

      // create dom element
      var container_id = 'viewer_'+page;
      
      if (!visible) {
        var style = 'background-color:black;position:absolute;top:0px;left:0px;width:100%;height:100%;z-index:0'//display:none';
      } else {
        var style = 'background-color:black;position:absolute;top:0px;left:0px;width:100%;height:100%;z-index:1';
      }

      $('#viewers').append('<div id="'+container_id+'" class="viewers" style="'+style+'"></div>');

      var ts = create_ts(page);//images[page];
      // var ts2 = segmentations[page];


      var viewer = OpenSeadragon({
          id:            container_id,
          prefixUrl:     "images/",
          navigatorSizeRatio: 0.25,
          minZoomImageRatio: 0.5,
          maxZoomPixelRatio: 10,
          showNavigationControl: false,
          animationTime: 0,
          imageLoaderLimit: 3,
          tileSources:   ts
        });


      viewer.innerTracker.keyHandler = null;
      viewer.innerTracker.keyDownHandler = null;

        window.onkeydown = this.onkey;

          if (!visible) {
              viewer.addHandler('tile-drawn', function() {
                  ready_for_next_slice = true;
              });
          }



          //return [viewer, null];
          return viewer;


  };

  function propagate_viewport() {

    viewer.viewport.panTo(seg_viewer.viewport.getCenter(), true);
    // center = null;

    // zoom = parseFloat(zoom);
    viewer.viewport.zoomTo(seg_viewer.viewport.getZoom(), null, true);    

  };


  window.onload = function() {


    var args = parse_args();

    server_name = args['server'];
    data_path = args['data_path'];
    g_width = parseInt(args['width'],10);
    g_height = parseInt(args['height'],10);
    g_depth = parseInt(args['depth'],10);
    if ('z' in args) {
        g_z = parseInt(args['z'],10);
    }
    else {
        g_z = 0;
    }

    // console.log(args)

    viewer = create_viewer(g_z, true, true);
    // seg_viewer = viewers[1];
    if (g_z < g_depth - 1)
        next_viewer = create_viewer(g_z+1, false, true, 1);
    else
        next_viewer = null;
    
    if (g_z > 0)
        prev_viewer = create_viewer(g_z-1, false, true, -1);
    else
        prev_viewer = null;



  }

  function onkey(e) {

      if (e.keyCode == 87) {
          move(1);
      } else if (e.keyCode == 83) {
          move(-1);
      }

  };

  // Adapted from the mb project by dhaean
  function move(sign) {

    if (g_z + 1*sign >= g_depth) {
        // console.log('reached right end');
        return;
    } else if (g_z + 1*sign < 0) {
        // console.log('reached left end');
        return;
    }

    var old_container = '#viewer_'+g_z;
    g_z += 1*sign;
    var new_container = '#viewer_'+g_z;

    // 
    //this._data_path = this._content[this._page].data_path;

    if (sign > 0) {
        // moving to next

        // we destroyed the old previous viewer
        if (prev_viewer) {
            // this._prev_viewer.removeAllHandlers('pan');
            // this._prev_viewer.removeAllHandlers('zoom');
            prev_viewer.destroy();
            // console.log('freeing previous viewer');
        }

        // the prev viewer is set to the current one
        var old_viewer = viewer;
        // old_viewer.removeAllHandlers('pan');
        // old_viewer.removeAllHandlers('zoom');        
        prev_viewer = viewer;
        // this._prev_viewer.removeAllHandlers('pan');
        // this._prev_viewer.removeAllHandlers('zoom');

        // the current viewer is set to the next one
        viewer = next_viewer;

        // this._viewer.addHandler('pan', this.propagate_viewport.bind(this));
        // this._viewer.addHandler('zoom', this.propagate_viewport.bind(this));


        // and the next viewer shall be a new one
        if (g_z+1 >= g_depth) {
            next_viewer = null;
        } else {
            // this._controller.request_meta_data(this._content[this._page+1]['data_path'])
            next_viewer = create_viewer(g_z+1, false, true);
        }

    } else {
        // moving to prev

        // we destroy the old next viewer
        if (next_viewer) {
            // this._next_viewer.removeAllHandlers('pan');
            // this._next_viewer.removeAllHandlers('zoom');      
            next_viewer.destroy();
            // console.log('freeing next viewer');
        }

        // the next viewer is set to the current one
        var old_viewer = viewer;
        // old_viewer.removeAllHandlers('pan');
        // old_viewer.removeAllHandlers('zoom');          
        next_viewer = viewer;
        // this._next_viewer.removeAllHandlers('pan');
        // this._next_viewer.removeAllHandlers('zoom'); 

        // the current viewer is set to the previous one
        viewer = prev_viewer;

        // this._viewer.addHandler('pan', this.propagate_viewport.bind(this));
        // this._viewer.addHandler('zoom', this.propagate_viewport.bind(this));


        // and the previous viewer shall be a new one
        if (g_z-1 < 0) {
            prev_viewer = null;
        } else {
            prev_viewer = create_viewer(g_z-1, false, true);
        }

    }

    viewer.viewport.panTo(old_viewer.viewport.getCenter(), true);
    viewer.viewport.zoomTo(old_viewer.viewport.getZoom(), null, true);

    $(new_container).css('z-index', 1);    
    $(old_container).css('z-index', 0);

  }


  </script>
</head>

<body>
<div id='viewers' style='position:absolute;top:0px;left:0px;width:100%;height:100%'></div>
</body>
</html>
